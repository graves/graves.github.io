<!DOCTYPE html>
<html>
  <head>
    <title>Graves</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
<link href="https://graves.github.io/_support/html/css/font-awesome.min.css" rel="stylesheet">
<link href="https://graves.github.io/_support/html/css/nucleus.css" rel="stylesheet">
<link href="https://graves.github.io/_support/html/css/flex.css" rel="stylesheet">
<link rel="stylesheet" href="https://graves.github.io/_support/html/highlightjs/styles/default.css">
<link rel="stylesheet" href="https://graves.github.io/_support/html/css/highlight-commands.css">
<link rel="stylesheet" href="https://graves.github.io/_support/html/css/bootstrap.min.css">
<script src="https://graves.github.io/_support/html/js/jquery-2.x.min.js"></script>
<script src="https://graves.github.io/_support/html/highlightjs/highlight.pack.js"></script>
<script src="https://graves.github.io/_support/html/js/highlight-commands.js"></script>
<meta name="description" content="nil">
nil<meta name="author" content="Thomas Graves">nil
  </head>
  <body>
    <header>
  <div class="logo">
    <a class="baselink" href="https://graves.github.io">Graves</a>
  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
  
</header>
<article>
  <aside>
    <ul class="menu">
   		<li data-nav-id="123" class="dd-item">
    		<a href="https://graves.github.io">
		       <i class="fa fa-fw fa-home"></i>
	    	</a>
        </li>

		
		  <li class="dd-item ">
			<div>
			  <a href="">
					
			  </a>
			  
			</div>
			  <ul class="dd-item">
				
			  </ul>
		  
		  </li>
		
    </ul>
  </aside>

  <section class="page">
    
	<h1>Modeling the Transmission Rate of COVID-19 with SIR in Smalltalk</h1>
		
	<h1>Modeling the Transmission Rate of COVID-19 with SIR in Smalltalk</h1>

<h2>Using Glamorous Toolkit, PolyMath and Roassal2 and Ordinary Differential Equations</h2>

<p>
From <a href="https://en.wikipedia.org/wiki/Compartmental_models_in_epidemiology#The_SIR_model">Wikipedia</a>:
</p>
<p>
<em> <code> The SIR model is one of the simplest compartmental models, and many models are derivatives of this basic form. The model consists of three compartments: S for the number of susceptible, I for the number of infectious, and R for the number of recovered or deceased (or immune) individuals. This model is reasonably predictive[citation needed] for infectious diseases that are transmitted from human to human, and where recovery confers lasting resistance, such as measles, mumps and rubella.

Spatial SIR model simulation. Each cell can infect its eight immediate neighbors.
These variables (S, I, and R) represent the number of people in each compartment at a particular time. To represent that the number of susceptible, infected and recovered individuals may vary over time (even if the total population size remains constant), we make the precise numbers a function of t (time): S(t), I(t) and R(t). For a specific disease in a specific population, these functions may be worked out in order to predict possible outbreaks and bring them under control. </code> </em>
</p>
<p>
Lucky for us the <a href="https://github.com/PolyMathOrg/PolyMath/">PolyMath</a> library contains everything we need to start solving Ordinary Differential Equations and even includes a <a href="https://github.com/PolyMathOrg/PolyMath/wiki/Quick-start-to-ODE">Tutorial</a> on working with the SIR model.
</p>
<p>
From the wiki:
</p>
<figure><pre><code class="smalltalk">|solver state system dt beta gamma values stepper diag|
dt := 1.0.
beta := 0.01.
gamma := 0.1.
system := PMExplicitSystem block: [ :x :t| |c|
	 c := Array new: 3.
	 c at: 1 put: (beta negated) * (x at: 1) * (x at: 2).
	 c at: 2 put: (beta * (x at: 1) * (x at: 2)) - (gamma * (x at: 2)).
	 c at: 3 put: gamma * (x at: 2).
	 c
	 ].
stepper := PMRungeKuttaStepper onSystem: system.
solver := (PMExplicitSolver new) stepper: stepper; system: system; dt: dt.
state := #(99 1 0).
values := (0.0 to: 200.0 by: dt) collect: [ :t| state := stepper doStep: state 
                                                          time: t stepSize: dt ].</code></pre><figcaption></figcaption></figure>

<p>
In order to begin using this code to create our own model we must first understand the <code>dt</code> , <code>beta</code> and <code>gamma</code> variables.
</p>
<p>
<code>dt</code> is a measure of time and in our model we'll use <code>1.0</code> so that each step represents <code>1 day</code>. 
<code>beta</code> is the <strong><em>transmission rate</em></strong>. We'll discuss this further in the following section.
<code>gamma</code> is the <strong><em>recovery rate</em></strong>. We'll discuss this further in the following section.
</p>
<h3>The SIR Model</h3>

<p>
I found the best explanations of the SIR model to be this <a href="https://en.wikipedia.org/wiki/Compartmental_models_in_epidemiology#The_SIR_model">Wikipedia</a> entry and the documentation of the R library <a href="https://cran.r-project.org/web/packages/shinySIR/vignettes/Vignette.html">ShinySIR</a>.
</p>
<p>
From <code>ShinySIR</code>:
</p>
<p>
<code><em>
In the simple SIR model (without births or deaths), susceptible individuals (S) become infected and move into the infected class (I). After some period of time, infected individuals recover and move into the recovered (or immune) class (R). Once immune, they remain so for life (i.e. they do not leave the recovered class). The corresponding equations are given by</em></code>
</p>
<ul>
<li><code> dS / dt = −βSI </code></li>
<li><code> dI / dt = βSI−γI </code></li>
<li><code> dR / dt = γI </code></li>
</ul>

<p>
<code><em>
where</em> S,I, <em>and</em> R, <em>are the numbers of susceptible, infected, and recovered individuals in the population. Suppose the unit of time we are considering is days, then</em>

β <em>is the transmission rate and</em> βSI <em>represents the number of susceptible individuals that become infected per day;</em>
γ <em>is the recovery rate and</em> γI <em>is the number of infected individuals that recover per day;</em>
1/γ <em>is the infectious period i.e. the average duration of time an individual remains infected.</em>
<em>
An important quantity of any disease model is the the reproductive number, R0, which represents the average number of secondary infections generated from one infectious individual in a completely susceptible population. For the SIR model,</em>

R0 = βN/γ,
 <em>where N=S+I+R is the total (constant) population size. Since R0 and the infectious period are more intuitive parameters, we use these as inputs for the built-in SIR model. We can then calculate</em> β <em>as</em>

β = R0γ/N.</code>
</p>
<p>
It's important to note that:
</p>
<ul>
<li>β is the mathematical notation for beta.</li>
<li>γ is the mathematical notation for gamma.</li>
</ul>

<p>
In order to calculate the beta parameter I source <code>R0</code> from <a href="https://www.imperial.ac.uk/media/imperial-college/medicine/sph/ide/gida-fellowships/Imperial-College-COVID19-transmissibility-25-01-2020.pdf">Report 3: Transmissibility of 2019-nCoV</a>as <code>2.6</code>. This means that on average each infected person will infect 2.6 others. I source the the average duration of recovery from <a href="https://www.who.int/bulletin/online_first/20-255695.pdf">CoronaTracker: World-wide COVID-19 Outbreak Data Analysis and Prediction</a> as <code>7.5 days</code>. 
</p>
<p>
Given the average duration of recovery it's trivial to calculate our gamma value.
</p>
<p>
<code>γ = 1/D</code> 
</p>
<p>
where <code>D</code> is the average duration of recovery.
</p>
<figure><pre><code class="smalltalk">| durationOfRecovery gamma |
durationOfRecovery := 7.5.
gamma := 1 / durationOfRecovery</code></pre><figcaption></figcaption></figure>

<p>
Given <code>R0</code>, <code>γ</code> and <code>N</code> (the total population size) it's trivial to calculate our beta value:
</p>
<p>
We'll start by setting <code>N</code> to the total population size of Florida. According to <a href="https://www.google.com/search?rlz=1C1CHBF_enUS880US880&sxsrf=ALeKk03BpRO2jyob9fJfErotMEWyBndmDw%3A1586996207554&ei=76OXXpmtIfKmggfIrJngDw&q=population+of+florida&oq=population+o&gs_lcp=CgZwc3ktYWIQARgAMgQIIxAnMgIIADICCAAyAggAMgIIADIFCAAQgwEyAggAMgIIADICCAAyAggAOgQIABBHOgUIABCRAjoECAAQQ0owCBcSLDBnNDA1ZzMzMGcyMDZnMTY2ZzE4MmcxNTJnMTU2ZzE0OWcxODNnMTgzZzE4ShsIGBIXMGcxZzFnMWcxZzFnMWcxZzFnMWczZzRQ1Pc1WN-DNmDrjDZoAHAEeACAAc4CiAGfEJIBCDAuMTAuMC4ymAEAoAEBqgEHZ3dzLXdpeg&sclient=psy-ab">Google</a>the population of Florida is <code>21.48 million</code>.
</p>
<figure><pre><code class="smalltalk">| durationOfRecovery gamma populationSize r0 beta |
durationOfRecovery := 7.5.
gamma := 1 / durationOfRecovery.

populationSize := 21480000.
r0 := 2.6.
beta := r0 * gamma / populationSize</code></pre><figcaption></figcaption></figure>

<p>
We now have enough information to start simulating COVID-19 transmission across a population using SIR.
</p>
<h3>Simulating COVID-19 transmission in Florida</h3>

<p>
Let's plug the information we have into the ODE tutorial from PolyMath.
</p>
<figure><pre><code class="smalltalk">| dt durationOfRecovery gamma populationSize r0 beta solver state system values stepper |
dt := 1.0.
durationOfRecovery := 7.5.
gamma := 1 / durationOfRecovery.

populationSize := 21480000.
r0 := 2.6.
beta := r0 * gamma / populationSize.

system := PMExplicitSystem block: [ :x :t| |c|
	 c := Array new: 3.
	 c at: 1 put: (beta negated) * (x at: 1) * (x at: 2).
	 c at: 2 put: (beta * (x at: 1) * (x at: 2)) - (gamma * (x at: 2)).
	 c at: 3 put: gamma * (x at: 2).
	 c
	 ].
stepper := PMRungeKuttaStepper onSystem: system.
solver := (PMExplicitSolver new) stepper: stepper; system: system; dt: dt.
state := #(21480000 1 0).
values := (0.0 to: 180.0 by: dt) collect: [ :t| state := stepper doStep: state 
                                                          time: t stepSize: dt ].</code></pre><figcaption></figcaption></figure>

<p>
This results in a multi-dimensional array indexed by days from the start of the spread to the 180th day (~6 months). Each entry in the array is an array containing the Susceptible, Infected, and Recovered individuals. This information is much easier for humans to digest when visualized. For this we'll use the wonderful <a href="http://agilevisualization.com/">Roassal2</a>
</p>
<p>
Let's take the values from our... uhhhh... <em>values</em> array and build some Roassal Data Frames.
</p>
<figure><pre><code class="smalltalk">| dt durationOfRecovery gamma populationSize r0 beta solver state system values stepper susceptible infected recovered b ds1 ds2 ds3 |
dt := 1.0.
durationOfRecovery := 7.5.
gamma := 1 / durationOfRecovery.

populationSize := 21480000.
r0 := 2.6.
beta := r0 * gamma / populationSize.

system := PMExplicitSystem block: [ :x :t| |c|
	 c := Array new: 3.
	 c at: 1 put: (beta negated) * (x at: 1) * (x at: 2).
	 c at: 2 put: (beta * (x at: 1) * (x at: 2)) - (gamma * (x at: 2)).
	 c at: 3 put: gamma * (x at: 2).
	 c
	 ].
stepper := PMRungeKuttaStepper onSystem: system.
solver := (PMExplicitSolver new) stepper: stepper; system: system; dt: dt.
state := #(21480000 1 0).
values := (0.0 to: 180.0 by: dt) collect: [ :t| state := stepper doStep: state 
                                                          time: t stepSize: dt ].
														  
susceptible := values collectWithIndex: [ :each :idx | Point x: idx y: (each at: 1) ].
infected := values collectWithIndex: [ :each :idx | Point x: idx y: (each at: 2) ].
recovered := values collectWithIndex: [ :each :idx | Point x: idx y: (each at: 3) ].

b := RTGrapher new.

ds1 := RTData new.
ds1 label: 'Susceptible'.
ds1 noDot.
ds1 points: susceptible.
ds1 connectColor: Color blue.
ds1 y: [ :v | v y ].
ds1 x: [ :v | v x ].
ds1 interaction popup text: [ :v | ((v key y) asInteger) asString, ' susceptible on day ', (v key x asString)].
b add: ds1.

ds2 := RTData new.
ds2 label: 'Infected'.
ds2 noDot.
ds2 points: infected.
ds2 connectColor: Color red.
ds2 y: [ :v | v y ].
ds2 x: [ :v | v x ].
ds2 interaction popup text: [ :v | ((v key y) asInteger) asString, ' infected on day ', (v key x asString)].
b add: ds2.

ds3 := RTData new.
ds3 label: 'Recovered'.
ds3 noDot.
ds3 points: recovered.
ds3 connectColor: Color green.
ds3 y: [ :v | v y ].
ds3 x: [ :v | v x ].
ds3  interaction popup text: [ :v | ((v key y) asInteger) asString, ' recovered on day ', (v key x asString)].
b add: ds3.

b addDecorator: (RTCursorFollower new color: Color gray).

b axisX title: 'Days'; noDecimal.
b axisY title: 'Population'; noDecimal.

b legend right.

b open</code></pre><figcaption></figcaption></figure>

<p>
As you can see, this lays out our data in an easily digestable fashion. It shows the peak of the infections happening on day 84 with 5,143,437 individuals infected.
</p>









  </section>

</article>

<footer>

<div class="footline">
    <div class="github-link">
      <a href="" target="blank"><i class="fa fa-code-fork"></i>Github</a>
    </div>
  </div>
</footer>

<script src="https://graves.github.io/_support/html/js/clipboard.min.js"></script>

<link href="https://graves.github.io/_support/html/css/featherlight.min.css" rel="stylesheet">
<script src="https://graves.github.io/_support/html/js/featherlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="https://graves.github.io/_support/html/js/flex.js"></script>
<!-- Prettify annotated paragraphs-->
    <script src="https://graves.github.io_support/html/js/annotated-paragraphs.js"></script>

  </body>
</html>
